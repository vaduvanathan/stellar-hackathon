<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create secondary key – SUPERNOVA</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23238636' width='32' height='32' rx='6'/><path fill='%23fff' d='M16 6l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z'/></svg>" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060b18;
      --bg2: #0a1128;
      --surface: rgba(15, 25, 60, 0.7);
      --border: rgba(100, 160, 255, 0.15);
      --border-glow: rgba(100, 160, 255, 0.3);
      --text: #e8edf5;
      --muted: #7b8ba8;
      --accent: #22d3ee;
      --accent2: #818cf8;
      --accent-dim: #0ea5c9;
      --warn: #fbbf24;
      --err: #f87171;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.6;
    }
    .wrap { max-width: 620px; margin: 0 auto; padding: 2.5rem 1.5rem; }
    h1 {
      font-size: 1.75rem; font-weight: 800; margin: 0 0 0.25rem 0;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #e8edf5, #22d3ee);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .tagline { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .card {
      position: relative;
      background: var(--surface);
      border-radius: 16px;
      padding: 1.5rem 1.75rem;
      margin-bottom: 1.25rem;
      backdrop-filter: blur(8px);
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute; inset: 0;
      border-radius: 16px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(34,211,238,0.3), rgba(129,140,248,0.15), rgba(34,211,238,0.1));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .card h2 { font-size: 0.8rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--accent); text-transform: uppercase; letter-spacing: 0.12em; }
    code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; background: rgba(34,211,238,0.08); padding: 0.15em 0.4em; border-radius: 4px; word-break: break-all; }
    label { display: block; margin-bottom: 0.35rem; color: var(--muted); font-size: 0.85rem; }
    input[type="text"], input[type="password"], input[type="email"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.9rem;
      background: rgba(6, 11, 24, 0.6);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    input:focus { outline: none; border-color: var(--accent); }
    select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.9rem;
      background: rgba(6, 11, 24, 0.6);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    button {
      background: var(--accent);
      color: #060b18;
      border: none;
      padding: 0.6rem 1.1rem;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { background: var(--accent-dim); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background: var(--accent-dim); color: #fff; }
    button.secondary {
      background: transparent; color: var(--text);
      border: 1px solid var(--border-glow);
    }
    button.secondary:hover { border-color: var(--accent); color: var(--accent); }
    .msg { margin-top: 0.75rem; font-size: 0.9rem; padding: 0.5rem 0; }
    .msg.ok { color: var(--accent); }
    .msg.err { color: var(--err); }
    .msg.loading { color: var(--muted); }
    .key-box {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(6, 11, 24, 0.5);
      border: 1px solid var(--accent);
      border-radius: 10px;
      word-break: break-all;
    }
    .key-box .label { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
    footer { margin-top: 2rem; text-align: center; color: var(--muted); font-size: 0.8rem; }
    footer a { color: var(--accent); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
  </style>
  <script src="https://unpkg.com/@stellar/freighter-api@2.0.0/build/index.min.js" crossorigin="anonymous"></script>
  <!-- Cache-bust so redeploys get latest -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <div class="wrap">
    <h1>Create secondary key</h1>
    <p class="tagline">We generate a <strong>secondary (sweep) key</strong> for your account. You add it as a signer; when you’re inactive, your nominee can use it (with the secret answer) to claim funds. We never see the key—it’s encrypted with the answer.</p>
    <p style="margin: 0 0 1.5rem 0; padding: 0.75rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; color: var(--muted);"><strong style="color: var(--text);">Where do I get the key?</strong> Right here. Fill the form below and click <strong>Create secondary key</strong>. Your secondary key (public key) will appear <strong>below the form</strong> on this page.</p>

    <section class="card" style="margin-bottom: 1.5rem;">
      <h2>Why add a “co-signer”?</h2>
      <p style="margin: 0 0 0.5rem 0; color: var(--muted); font-size: 0.9rem;">When you create a Stellar wallet you get <strong>one keypair</strong> (one private key). That key alone can sign for your account. A <strong>co-signer</strong> is a second public key you add to the same account so that <strong>either</strong> your main key <strong>or</strong> this second key can sign. We generated that second keypair for you; we only show you its <strong>public</strong> key. You add it to your account by sending a Stellar transaction (Set Options → add signer) signed with your <strong>main</strong> key. After that, when you’re inactive, your nominee can use the second key (unlocked with the answer) to sweep funds.</p>
    </section>

    <section class="card">
      <h2>Step 1: Fill the form</h2>
      <p style="margin: 0 0 1rem 0; color: var(--muted); font-size: 0.9rem;">We’ll create a keypair, encrypt the secret with your answer, and show you the <strong>public key</strong> in Step 2 below. Add that public key as a <strong>signer</strong> to your Stellar account (e.g. in Stellar Laboratory or Freighter).</p>
      <form id="nominee-form">
        <label for="nominee_depositor">Your Stellar account (G…)</label>
        <input type="text" id="nominee_depositor" placeholder="G..." maxlength="56" required>
        <label for="nominee_phone">Nominee phone (E.164, e.g. +919876543210)</label>
        <input type="text" id="nominee_phone" placeholder="+1234567890" required>
        <label for="nominee_beneficiary">Nominee Stellar address (G…, where to send funds on claim)</label>
        <input type="text" id="nominee_beneficiary" placeholder="G... (optional at register)">
        <label for="nominee_question">Question (only the nominee should know the answer)</label>
        <input type="text" id="nominee_question" placeholder="e.g. What was the name of your first pet?">
        <label for="nominee_answer">Answer (secret – we never store it; used to encrypt the key)</label>
        <input type="password" id="nominee_answer" placeholder="Answer" autocomplete="off">
        <label for="nominee_inactivity">Send claim SMS after no activity for</label>
        <select id="nominee_inactivity">
          <option value="0">5 minutes (test)</option>
          <option value="7">7 days</option>
          <option value="30" selected>30 days</option>
          <option value="90">90 days</option>
        </select>
        <button type="submit">Create secondary key</button>
        <div id="nominee-msg" class="msg"></div>
      </form>
    </section>

    <section class="card" id="result-card" style="display: none;">
      <h2>Step 2: Your secondary key (copy this)</h2>
      <p style="margin: 0 0 0.75rem 0; color: var(--muted); font-size: 0.9rem;">This is the key we generated for you. Add this public key as a <strong>signer</strong> to your Stellar account. When your account is inactive for the set period, we’ll send an SMS to your nominee with a claim link; only the correct answer will unlock this key in the browser to sweep funds.</p>
      <div class="key-box">
        <div class="label">Your secondary key — add this as a signer to your account</div>
        <code class="mono" id="sweep-public-key"></code>
      </div>
      <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text);"><strong>Add this key as a signer</strong></p>
      <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--muted);">Use <strong>Set Options</strong>: signer = the key above, weight = 1. You can build the transaction in Stellar Lab or sign it here with Freighter.</p>
      <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: var(--warn);">Click <strong>Build &amp; sign here</strong> first. If Freighter says not connected, click <strong>Connect wallet</strong> and <strong>Allow</strong> in the popup, then try again. Or use Stellar Lab to build manually.</p>
      <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
        <button type="button" id="add-signer-btn" class="primary" style="background: var(--accent-dim); color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-family: inherit; cursor: pointer; font-size: 0.95rem; font-weight: 600;">Build &amp; sign here (Freighter)</button>
        <button type="button" id="connect-wallet-btn" class="secondary" style="background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; font-family: inherit; cursor: pointer; font-size: 0.95rem; font-weight: 600;">Connect wallet (Freighter)</button>
        <span id="connect-status" style="font-size: 0.9rem; color: var(--muted);"></span>
        <a id="open-lab-btn" href="https://lab.stellar.org/transaction/build" target="_blank" rel="noopener" class="secondary" style="display: inline-block; background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; font-family: inherit; cursor: pointer; text-decoration: none; font-size: 0.95rem; font-weight: 600;">Open Stellar Lab → Build transaction</a>
      </div>
      <div id="add-signer-msg" class="msg" style="margin-top: 0.5rem;"></div>
    </section>

    <footer>
      <a href="/">← Back to SUPERNOVA</a>
    </footer>
  </div>

  <script>
    // UMD may expose API on .default (e.g. @stellar/freighter-api 2.x)
    function getFreighterApi() {
      var w = window.freighterApi || window.freighter;
      if (!w) return null;
      if (w.default && typeof w.default.signTransaction === 'function') return w.default;
      return w;
    }

    document.getElementById('connect-wallet-btn').addEventListener('click', async function () {
      var statusEl = document.getElementById('connect-status');
      statusEl.textContent = 'Opening Freighter…';
      statusEl.style.color = 'var(--muted)';
      try {
        var api = getFreighterApi();
        if (!api || typeof api.signTransaction !== 'function') {
          statusEl.textContent = 'Freighter not found. Install the extension and refresh.';
          statusEl.style.color = 'var(--err)';
          return;
        }
        function showAddress(addr) {
          if (addr && addr.length > 0) {
            statusEl.textContent = 'Connected: ' + addr.slice(0, 8) + '… Now click "Build & sign here".';
            statusEl.style.color = 'var(--accent)';
            return true;
          }
          return false;
        }
        // Try setAllowed first — one "Allow this site?" prompt; works even when requestAccess returns empty (known bug)
        if (typeof api.setAllowed === 'function') {
          var setRes = await api.setAllowed().catch(function (e) { return { isAllowed: false, error: e }; });
          if (setRes && (setRes.isAllowed === true || setRes.allowed === true)) {
            statusEl.textContent = 'Connected. Now click "Build & sign here".';
            statusEl.style.color = 'var(--accent)';
            return;
          }
          if (setRes && setRes.error) {
            statusEl.textContent = 'Freighter: ' + (setRes.error.message || String(setRes.error));
            statusEl.style.color = 'var(--err)';
            return;
          }
        }
        // Then requestAccess (may return empty address even after Allow — known Freighter bug)
        if (typeof api.requestAccess !== 'function') {
          statusEl.textContent = 'Click "Build & sign here" and click Allow in Freighter when asked.';
          statusEl.style.color = 'var(--warn)';
          return;
        }
        var res = await api.requestAccess().catch(function (e) { return { error: e && (e.message || String(e)) }; });
        if (res && res.error) {
          statusEl.textContent = 'Freighter: ' + (typeof res.error === 'string' ? res.error : 'User denied or error');
          statusEl.style.color = 'var(--err)';
          return;
        }
        var addr = (res && (res.address || res.publicKey)) || '';
        if (showAddress(addr)) return;
        statusEl.textContent = 'Site may already be allowed. Click "Build & sign here" — if Freighter asks, click Allow then Confirm.';
        statusEl.style.color = 'var(--warn)';
      } catch (e) {
        statusEl.textContent = (e && e.message) || 'Connection failed';
        statusEl.style.color = 'var(--err)';
      }
    });

    document.getElementById('nominee-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById('nominee-msg');
      const resultCard = document.getElementById('result-card');
      resultCard.style.display = 'none';
      msgEl.textContent = '';
      msgEl.className = 'msg';
      const body = {
        depositor_account_id: document.getElementById('nominee_depositor').value.trim(),
        beneficiary_phone: document.getElementById('nominee_phone').value.trim(),
        beneficiary_stellar_address: document.getElementById('nominee_beneficiary').value.trim() || undefined,
        question: document.getElementById('nominee_question').value.trim(),
        answer: document.getElementById('nominee_answer').value.trim(),
        inactivity_days: document.getElementById('nominee_inactivity').value
      };
      if (!body.depositor_account_id || !body.beneficiary_phone || !body.question || !body.answer) {
        msgEl.textContent = 'Please fill: Your account, phone, question, and answer.';
        msgEl.className = 'msg err';
        return;
      }
      msgEl.textContent = 'Creating secondary key…';
      msgEl.className = 'msg loading';
      try {
        const r = await fetch('/api/nominee/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const d = await r.json().catch(() => ({}));
        if (r.ok) {
          msgEl.textContent = 'Secondary key created. Add the key below as a signer to your account.';
          msgEl.className = 'msg ok';
          document.getElementById('sweep-public-key').textContent = d.sweep_public_key || '';
          resultCard.style.display = 'block';
          resultCard.scrollIntoView({ behavior: 'smooth' });
        } else {
          msgEl.textContent = d.error || 'Registration failed';
          msgEl.className = 'msg err';
        }
      } catch (e) {
        msgEl.textContent = e.message || 'Request failed';
        msgEl.className = 'msg err';
      }
    });

    document.getElementById('open-lab-btn').addEventListener('click', function (e) {
      this.href = 'https://lab.stellar.org/transaction/build';
    });

    document.getElementById('add-signer-btn').addEventListener('click', async function () {
      var msgEl = document.getElementById('add-signer-msg');
      var accountPublicKey = document.getElementById('nominee_depositor').value.trim();
      var signerPublicKey = document.getElementById('sweep-public-key').textContent.trim();
      if (!accountPublicKey || !signerPublicKey) {
        msgEl.textContent = 'Your Stellar account and the secondary key above are required.';
        msgEl.className = 'msg err';
        return;
      }
      msgEl.textContent = 'Building transaction…';
      msgEl.className = 'msg loading';
      try {
        var buildRes = await fetch('/api/build-add-signer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            account_public_key: accountPublicKey,
            signer_public_key: signerPublicKey,
          }),
        });
        var buildData = await buildRes.json().catch(function () { return {}; });
        if (!buildRes.ok) {
          msgEl.textContent = buildData.error || 'Build failed. Try "Open Stellar Lab" to add the signer manually.';
          msgEl.className = 'msg err';
          return;
        }
        var txXdr = buildData.transaction_xdr;
        if (!txXdr) {
          msgEl.textContent = 'No transaction returned from server.';
          msgEl.className = 'msg err';
          return;
        }
        var networkPassphrase = 'Test SDF Network ; September 2015';
        try {
          var cfgRes = await fetch('/api/lock-config');
          if (cfgRes.ok) {
            var cfg = await cfgRes.json();
            if (cfg.network_passphrase) networkPassphrase = cfg.network_passphrase;
          }
        } catch (_) {}
        var freighterApi = getFreighterApi();
        if (!freighterApi || typeof freighterApi.signTransaction !== 'function') {
          msgEl.textContent = 'Freighter extension not found. Use "Open Stellar Lab" to build and sign there.';
          msgEl.className = 'msg err';
          return;
        }
        msgEl.textContent = 'Connecting to Freighter (allow this site if a popup appears)…';
        var allowed = false;
        if (typeof freighterApi.requestAccess === 'function') {
          var accessRes = await freighterApi.requestAccess().catch(function () { return {}; });
          allowed = !accessRes.error && !!accessRes.address;
        }
        if (!allowed && typeof freighterApi.setAllowed === 'function') {
          var setRes = await freighterApi.setAllowed().catch(function () { return {}; });
          allowed = !!(setRes && setRes.isAllowed);
        }
        msgEl.textContent = 'Open Freighter and click Confirm to sign…';
        var signed = await freighterApi.signTransaction(txXdr, { networkPassphrase: networkPassphrase });
        var signedXdr = signed && (signed.signedTransaction || signed.signedEnvelope || signed.signedTxXdr || signed);
        if (!signedXdr) {
          msgEl.textContent = 'Signing cancelled or failed.';
          msgEl.className = 'msg err';
          return;
        }
        msgEl.textContent = 'Submitting…';
        var submitRes = await fetch('/api/claim/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signed_envelope_xdr: signedXdr }),
        });
        var submitData = await submitRes.json().catch(function () { return {}; });
        if (submitRes.ok && submitData.status === 'success') {
          msgEl.textContent = 'Done! Co-signer added. Transaction: ' + (submitData.hash || '');
          msgEl.className = 'msg ok';
        } else {
          msgEl.textContent = submitData.error || (submitRes.status === 500 ? 'Server error.' : 'Submit failed');
          msgEl.className = 'msg err';
        }
      } catch (e) {
        msgEl.textContent = (e.message || String(e)) + '. Try "Open Stellar Lab" to add the signer manually.';
        msgEl.className = 'msg err';
      }
    });
  </script>
</body>
</html>
