<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create secondary key – Walletsurance</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23238636' width='32' height='32' rx='6'/><path fill='%23fff' d='M16 6l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z'/></svg>" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #3fb950;
      --accent-dim: #238636;
      --warn: #d29922;
      --err: #f85149;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.6;
    }
    .wrap { max-width: 560px; margin: 0 auto; padding: 2rem 1rem; }
    h1 { font-size: 1.75rem; font-weight: 600; margin: 0 0 0.25rem 0; letter-spacing: -0.02em; }
    .tagline { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.25rem;
    }
    .card h2 { font-size: 0.95rem; font-weight: 600; margin: 0 0 0.75rem 0; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; background: rgba(255,255,255,0.06); padding: 0.15em 0.4em; border-radius: 4px; word-break: break-all; }
    label { display: block; margin-bottom: 0.35rem; color: var(--muted); font-size: 0.85rem; }
    input[type="text"], input[type="password"], input[type="email"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    input:focus { outline: none; border-color: var(--accent); }
    select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.6rem 1.1rem;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: var(--accent-dim); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    button.secondary:hover { border-color: var(--muted); }
    .msg { margin-top: 0.75rem; font-size: 0.9rem; padding: 0.5rem 0; }
    .msg.ok { color: var(--accent); }
    .msg.err { color: var(--err); }
    .msg.loading { color: var(--muted); }
    .key-box {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: 8px;
      word-break: break-all;
    }
    .key-box .label { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
    footer { margin-top: 2rem; text-align: center; color: var(--muted); font-size: 0.8rem; }
    footer a { color: var(--accent); text-decoration: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/stellar-sdk@11.2.0/dist/stellar-sdk.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@stellar/freighter-api@2.0.0/build/index.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <h1>Create secondary key</h1>
    <p class="tagline">We generate a <strong>secondary (sweep) key</strong> for your account. You add it as a signer; when you’re inactive, your nominee can use it (with the secret answer) to claim funds. We never see the key—it’s encrypted with the answer.</p>
    <p style="margin: 0 0 1.5rem 0; padding: 0.75rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; color: var(--muted);"><strong style="color: var(--text);">Where do I get the key?</strong> Right here. Fill the form below and click <strong>Create secondary key</strong>. Your secondary key (public key) will appear <strong>below the form</strong> on this page.</p>

    <section class="card" style="margin-bottom: 1.5rem;">
      <h2>Why add a “co-signer”?</h2>
      <p style="margin: 0 0 0.5rem 0; color: var(--muted); font-size: 0.9rem;">When you create a Stellar wallet you get <strong>one keypair</strong> (one private key). That key alone can sign for your account. A <strong>co-signer</strong> is a second public key you add to the same account so that <strong>either</strong> your main key <strong>or</strong> this second key can sign. We generated that second keypair for you; we only show you its <strong>public</strong> key. You add it to your account by sending a Stellar transaction (Set Options → add signer) signed with your <strong>main</strong> key. After that, when you’re inactive, your nominee can use the second key (unlocked with the answer) to sweep funds.</p>
    </section>

    <section class="card">
      <h2>Step 1: Fill the form</h2>
      <p style="margin: 0 0 1rem 0; color: var(--muted); font-size: 0.9rem;">We’ll create a keypair, encrypt the secret with your answer, and show you the <strong>public key</strong> in Step 2 below. Add that public key as a <strong>signer</strong> to your Stellar account (e.g. in Stellar Laboratory or Freighter).</p>
      <form id="nominee-form">
        <label for="nominee_depositor">Your Stellar account (G…)</label>
        <input type="text" id="nominee_depositor" placeholder="G..." maxlength="56" required>
        <label for="nominee_phone">Nominee phone (E.164, e.g. +919876543210)</label>
        <input type="text" id="nominee_phone" placeholder="+1234567890" required>
        <label for="nominee_beneficiary">Nominee Stellar address (G…, where to send funds on claim)</label>
        <input type="text" id="nominee_beneficiary" placeholder="G... (optional at register)">
        <label for="nominee_question">Question (only the nominee should know the answer)</label>
        <input type="text" id="nominee_question" placeholder="e.g. What was the name of your first pet?">
        <label for="nominee_answer">Answer (secret – we never store it; used to encrypt the key)</label>
        <input type="password" id="nominee_answer" placeholder="Answer" autocomplete="off">
        <label for="nominee_inactivity">Send claim SMS after no activity for (days)</label>
        <select id="nominee_inactivity">
          <option value="7">7 days</option>
          <option value="30" selected>30 days</option>
          <option value="90">90 days</option>
        </select>
        <button type="submit">Create secondary key</button>
        <div id="nominee-msg" class="msg"></div>
      </form>
    </section>

    <section class="card" id="result-card" style="display: none;">
      <h2>Step 2: Your secondary key (copy this)</h2>
      <p style="margin: 0 0 0.75rem 0; color: var(--muted); font-size: 0.9rem;">This is the key we generated for you. Add this public key as a <strong>signer</strong> to your Stellar account. When your account is inactive for the set period, we’ll send an SMS to your nominee with a claim link; only the correct answer will unlock this key in the browser to sweep funds.</p>
      <div class="key-box">
        <div class="label">Your secondary key — add this as a signer to your account</div>
        <code class="mono" id="sweep-public-key"></code>
      </div>
      <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text);"><strong>Option A — Add as co-signer with Freighter (easiest)</strong></p>
      <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--muted);">Use the same Stellar account as in the form above. Click the button below; Freighter will open for you to sign one transaction that adds this key as a signer.</p>
      <button type="button" id="add-signer-btn" class="secondary" style="margin-top: 0.5rem; background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; font-family: inherit; cursor: pointer;">Add as co-signer with Freighter</button>
      <div id="add-signer-msg" class="msg"></div>
      <p style="margin-top: 1.25rem; font-size: 0.9rem; color: var(--text);"><strong>Option B — Do it manually in Stellar Laboratory</strong></p>
      <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--muted);">Go to <a href="https://laboratory.stellar.org/#account-viewer?network=test" target="_blank" rel="noopener" style="color: var(--accent);">Stellar Laboratory → Account Viewer</a> (Test network). Enter your account, then go to “Signers” and add the key above as a new signer with weight 1.</p>
    </section>

    <footer>
      <a href="/">← Back to Walletsurance</a>
    </footer>
  </div>

  <script>
    document.getElementById('nominee-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msgEl = document.getElementById('nominee-msg');
      const resultCard = document.getElementById('result-card');
      resultCard.style.display = 'none';
      msgEl.textContent = '';
      msgEl.className = 'msg';
      const body = {
        depositor_account_id: document.getElementById('nominee_depositor').value.trim(),
        beneficiary_phone: document.getElementById('nominee_phone').value.trim(),
        beneficiary_stellar_address: document.getElementById('nominee_beneficiary').value.trim() || undefined,
        question: document.getElementById('nominee_question').value.trim(),
        answer: document.getElementById('nominee_answer').value.trim(),
        inactivity_days: document.getElementById('nominee_inactivity').value
      };
      if (!body.depositor_account_id || !body.beneficiary_phone || !body.question || !body.answer) {
        msgEl.textContent = 'Please fill: Your account, phone, question, and answer.';
        msgEl.className = 'msg err';
        return;
      }
      msgEl.textContent = 'Creating secondary key…';
      msgEl.className = 'msg loading';
      try {
        const r = await fetch('/api/nominee/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const d = await r.json().catch(() => ({}));
        if (r.ok) {
          msgEl.textContent = 'Secondary key created. Add the key below as a signer to your account.';
          msgEl.className = 'msg ok';
          document.getElementById('sweep-public-key').textContent = d.sweep_public_key || '';
          resultCard.style.display = 'block';
          resultCard.scrollIntoView({ behavior: 'smooth' });
        } else {
          msgEl.textContent = d.error || 'Registration failed';
          msgEl.className = 'msg err';
        }
      } catch (e) {
        msgEl.textContent = e.message || 'Request failed';
        msgEl.className = 'msg err';
      }
    });

    document.getElementById('add-signer-btn').addEventListener('click', async function () {
      const msgEl = document.getElementById('add-signer-msg');
      const accountPublicKey = document.getElementById('nominee_depositor').value.trim();
      const signerPublicKey = document.getElementById('sweep-public-key').textContent.trim();
      if (!accountPublicKey || !signerPublicKey) {
        msgEl.textContent = 'Your Stellar account and the secondary key above are required.';
        msgEl.className = 'msg err';
        return;
      }
      msgEl.textContent = 'Building transaction…';
      msgEl.className = 'msg loading';
      try {
        const StellarSdk = window.StellarSdk;
        if (!StellarSdk || !StellarSdk.Server) {
          msgEl.textContent = 'Stellar SDK not loaded. Refresh the page.';
          msgEl.className = 'msg err';
          return;
        }
        let networkPassphrase = 'Test SDF Network ; September 2015';
        let horizonUrl = 'https://horizon-testnet.stellar.org';
        try {
          const cfgRes = await fetch('/api/lock-config');
          if (cfgRes.ok) {
            const cfg = await cfgRes.json();
            if (cfg.network_passphrase) networkPassphrase = cfg.network_passphrase;
            if (cfg.horizon_url) horizonUrl = cfg.horizon_url.replace(/\/$/, '');
          }
        } catch (_) {}
        var server = new StellarSdk.Server(horizonUrl);
        var sourceAccount = await server.loadAccount(accountPublicKey);
        var fee = (typeof StellarSdk.BASE_FEE !== 'undefined') ? StellarSdk.BASE_FEE : 100;
        var builder = new StellarSdk.TransactionBuilder(sourceAccount, {
          fee: String(fee),
          networkPassphrase: networkPassphrase,
        });
        builder.addOperation(StellarSdk.Operation.setOptions({
          signer: {
            ed25519PublicKey: signerPublicKey,
            weight: 1,
          },
        }));
        var tx = builder.setTimeout(180).build();
        var txXdr = tx.toEnvelope().toXDR('base64');
        msgEl.textContent = 'Open Freighter to sign…';
        msgEl.className = 'msg loading';
        const freighterApi = window.freighterApi || window.freighter;
        if (!freighterApi || !freighterApi.signTransaction) {
          msgEl.textContent = 'Freighter extension not found. Use Option B (Stellar Laboratory) instead.';
          msgEl.className = 'msg err';
          return;
        }
        const signed = await freighterApi.signTransaction(txXdr, { networkPassphrase: networkPassphrase });
        const signedXdr = signed && (signed.signedTransaction || signed.signedEnvelope || signed);
        if (!signedXdr) {
          msgEl.textContent = 'Signing cancelled or failed.';
          msgEl.className = 'msg err';
          return;
        }
        msgEl.textContent = 'Submitting…';
        const submitRes = await fetch('/api/claim/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ signed_envelope_xdr: signedXdr }),
        });
        const submitData = await submitRes.json().catch(() => ({}));
        if (submitRes.ok && submitData.status === 'success') {
          msgEl.textContent = 'Done! Co-signer added. Transaction: ' + (submitData.hash || '');
          msgEl.className = 'msg ok';
        } else {
          msgEl.textContent = submitData.error || (submitRes.status === 500 ? 'Server error (500).' : 'Submit failed');
          msgEl.className = 'msg err';
        }
      } catch (e) {
        msgEl.textContent = (e.message || e) + (e.response ? ' (check account exists on this network)' : '');
        msgEl.className = 'msg err';
      }
    });
  </script>
</body>
</html>
