<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Claim – SUPERNOVA</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23060b18' width='32' height='32' rx='6'/><path fill='%2322d3ee' d='M16 6l2 6h6l-5 4 2 6-5-4-5 4 2-6-5-4h6z'/></svg>" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #030712;
      --surface: rgba(10, 17, 40, 0.75);
      --border: rgba(100, 160, 255, 0.12);
      --border-glow: rgba(100, 160, 255, 0.25);
      --text: #e8edf5;
      --muted: #7b8ba8;
      --accent: #22d3ee;
      --accent2: #818cf8;
      --accent3: #a855f7;
      --magenta: #ec4899;
      --accent-dim: #0ea5c9;
      --warn: #fbbf24;
      --err: #f87171;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
    }
    .scroll-progress {
      position: fixed; top: 0; left: 0; z-index: 9999;
      height: 3px; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--magenta), var(--accent));
      background-size: 300% 100%;
      animation: progress-shimmer 3s linear infinite;
      box-shadow: 0 0 12px rgba(34,211,238,0.5);
      transition: width 0.1s linear;
    }
    @keyframes progress-shimmer { 0%{background-position:0% 50%} 100%{background-position:300% 50%} }
    #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
    .navbar {
      position: fixed; top: 3px; left: 0; right: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.75rem 1.25rem;
      background: rgba(3, 7, 18, 0.8);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
    }
    .navbar-brand {
      display: flex; align-items: center; gap: 0.5rem;
      font-weight: 900; font-size: 1rem; color: var(--text);
      text-decoration: none; letter-spacing: 0.04em;
    }
    .navbar-brand svg { width: 24px; height: 24px; }
    .navbar-back {
      color: var(--muted); text-decoration: none; font-size: 0.85rem; font-weight: 500;
      transition: color 0.2s; display: flex; align-items: center; gap: 0.3rem;
    }
    .navbar-back:hover { color: var(--accent); }
    .wrap { max-width: 600px; margin: 0 auto; padding: 5rem 1.25rem 2.5rem; position: relative; z-index: 1; }
    .page-header { margin-bottom: 1.75rem; }
    .page-header h1 {
      font-size: clamp(1.5rem, 5vw, 2rem); font-weight: 900;
      background: linear-gradient(135deg, #e8edf5 0%, #22d3ee 50%, #818cf8 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      margin-bottom: 0.5rem;
    }
    .page-header .tagline { color: var(--muted); font-size: 0.9rem; line-height: 1.6; }
    .reveal {
      opacity: 0; transform: translateY(30px) scale(0.98);
      transition: opacity 0.7s cubic-bezier(0.16,1,0.3,1), transform 0.7s cubic-bezier(0.16,1,0.3,1);
    }
    .reveal.visible { opacity: 1; transform: translateY(0) scale(1); }
    .card {
      position: relative; border-radius: 20px; padding: 1.5rem;
      margin-bottom: 1.5rem; backdrop-filter: blur(12px); overflow: hidden;
      background: linear-gradient(135deg, rgba(10,17,40,0.85), rgba(34,211,238,0.04), rgba(129,140,248,0.06), rgba(10,17,40,0.85));
    }
    .card::before {
      content: ''; position: absolute; inset: 0; border-radius: 20px; padding: 1px;
      background: linear-gradient(135deg, rgba(34,211,238,0.25), rgba(129,140,248,0.15), rgba(168,85,247,0.1), rgba(34,211,238,0.05));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    .card h2 {
      font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.14em;
      margin-bottom: 0.75rem;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    label { display: block; margin-bottom: 0.4rem; color: var(--muted); font-size: 0.85rem; font-weight: 500; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 0.7rem 0.85rem; margin-bottom: 1rem;
      background: rgba(3, 7, 18, 0.6); border: 1px solid var(--border); border-radius: 12px;
      color: var(--text); font-family: inherit; font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(34,211,238,0.1); }
    input[type="radio"] { accent-color: var(--accent); }
    button {
      font-family: inherit; font-size: 0.95rem; font-weight: 700; cursor: pointer;
      padding: 0.7rem 1.3rem; border-radius: 12px; border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #060b18; box-shadow: 0 4px 20px rgba(34,211,238,0.2);
      transition: all 0.2s; width: 100%;
    }
    button:hover { box-shadow: 0 6px 30px rgba(34,211,238,0.4); transform: translateY(-1px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    code, .mono {
      font-family: 'JetBrains Mono', monospace; font-size: 0.82em;
      background: rgba(34,211,238,0.08); padding: 0.15em 0.4em; border-radius: 4px; word-break: break-all;
    }
    .msg { margin-top: 0.75rem; font-size: 0.9rem; }
    .msg.ok { color: var(--accent); }
    .msg.err { color: var(--err); }
    .msg.loading { color: var(--muted); }
    .hidden { display: none; }
    .radio-group label {
      display: flex; align-items: center; gap: 0.5rem; cursor: pointer;
      padding: 0.5rem 0; font-size: 0.9rem; color: var(--text);
    }
    .site-footer {
      margin-top: 2.5rem; text-align: center; color: var(--muted); font-size: 0.85rem; padding-bottom: 2rem;
    }
    .site-footer a { color: var(--accent); text-decoration: none; font-weight: 600; }
    .site-footer a:hover { text-decoration: underline; }
    .cursor-particle {
      position: fixed; width: 6px; height: 6px; border-radius: 50%;
      pointer-events: none; z-index: 9998; opacity: 0;
      animation: particle-fade 0.8s ease-out forwards;
    }
    @keyframes particle-fade { 0%{opacity:1;transform:scale(1)} 100%{opacity:0;transform:scale(0)} }
    @media (max-width: 768px) {
      .wrap { padding: 4.5rem 1rem 2rem; }
      .card { padding: 1.25rem; border-radius: 16px; }
    }
    @media (max-width: 400px) {
      .wrap { padding: 4rem 0.75rem 1.5rem; }
      .navbar { padding: 0.6rem 0.75rem; }
      .card { padding: 1rem; }
      input[type="text"], input[type="password"] { font-size: 16px; padding: 0.65rem 0.75rem; }
      button { padding: 0.65rem 1rem; font-size: 0.9rem; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/stellar-sdk@11.2.0/dist/stellar-sdk.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="scroll-progress" id="scroll-progress"></div>
  <canvas id="starfield"></canvas>

  <nav class="navbar">
    <a href="/" class="navbar-brand">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 236.36 200">
        <path fill="#22d3ee" d="M203,26.16l-28.46,14.5-137.43,70a82.49,82.49,0,0,1-.7-10.69A81.87,81.87,0,0,1,158.2,28.6l16.29-8.3,2.43-1.24A100,100,0,0,0,18.18,100q0,3.82.29,7.61a18.19,18.19,0,0,1-9.88,17.58L0,129.57V150l25.29-12.89,0,0,8.19-4.18,8.07-4.11v0L186.43,55l16.28-8.29,33.65-17.15V9.14Z"/>
        <path fill="#22d3ee" d="M236.36,50,49.78,145,33.5,153.31,0,170.38v20.41l33.27-16.95,28.46-14.5L199.3,89.24A83.45,83.45,0,0,1,200,100,81.87,81.87,0,0,1,78.09,171.36l-1,.53-17.66,9A100,100,0,0,0,218.18,100c0-2.57-.1-5.14-.29-7.68a18.2,18.2,0,0,1,9.87-17.58l8.6-4.38Z"/>
      </svg>
      SUPERNOVA
    </a>
    <a href="/" class="navbar-back">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      Home
    </a>
  </nav>

  <div class="wrap">
    <div class="page-header reveal">
      <h1>SUPERNOVA Claim</h1>
      <p class="tagline">You've been named as a nominee. Answer the question to unlock and sweep funds to your Stellar address or bank account.</p>
    </div>

    <div id="load-err" class="card hidden reveal">
      <p class="msg err" id="load-err-text"></p>
    </div>

    <div id="claim-card" class="card hidden reveal">
      <h2>Question</h2>
      <p id="question-text" style="margin: 0 0 1rem 0; color: var(--text); font-weight: 600;"></p>
      <label for="answer">Your answer (unlocks the key only in this browser; we never see it)</label>
      <input type="password" id="answer" name="answer" placeholder="Enter the answer" autocomplete="off">

      <p style="margin: 0.5rem 0 0.5rem 0; color: var(--muted); font-size: 0.9rem;">How do you want to receive the funds?</p>
      <div class="radio-group" style="margin-bottom: 0.75rem;">
        <label><input type="radio" name="receive_mode" value="stellar" checked> Receive in my Stellar wallet (G…)</label>
        <label><input type="radio" name="receive_mode" value="bank"> Receive in my bank account (mock)</label>
      </div>

      <div id="stellar-dest">
        <label for="beneficiary">Stellar address to receive funds (G…)</label>
        <input type="text" id="beneficiary" name="beneficiary" placeholder="G..." maxlength="56">
      </div>
      <div id="bank-dest" class="hidden" style="margin-top: 0.5rem;">
        <p style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--muted);">We sweep to the Stellar address above, then request a bank payout (mock).</p>
        <label for="bank_holder">Account holder name</label>
        <input type="text" id="bank_holder" placeholder="Jane Doe">
        <label for="bank_account">Account number</label>
        <input type="text" id="bank_account" placeholder="1234567890">
        <label for="bank_ifsc">IFSC code</label>
        <input type="text" id="bank_ifsc" placeholder="SBIN0001234">
        <label for="bank_name">Bank name (optional)</label>
        <input type="text" id="bank_name" placeholder="Example Bank">
      </div>

      <button type="button" id="claim-btn">Unlock &amp; claim</button>
      <div id="claim-msg" class="msg"></div>
    </div>

    <div id="loading" class="card reveal">
      <p class="msg loading">Loading claim data…</p>
    </div>

    <footer class="site-footer reveal">
      <a href="/">← Back to SUPERNOVA</a>
    </footer>
  </div>

  <script>
    /* Starfield */
    (function(){
      const c=document.getElementById('starfield'),x=c.getContext('2d');let W,H,stars=[];
      const N=200,L=[{s:.02,mn:.4,mx:1.2,a:.5},{s:.05,mn:.8,mx:2,a:.7},{s:.1,mn:1.2,mx:3,a:.9}];
      const C=['#22d3ee','#818cf8','#a855f7','#e8edf5','#ec4899','#e8edf5'];
      function rs(){W=c.width=innerWidth;H=c.height=innerHeight}
      function cs(){stars=[];for(let i=0;i<N;i++){const l=L[Math.random()*3|0];stars.push({x:Math.random()*W,y:Math.random()*H*3,sz:l.mn+Math.random()*(l.mx-l.mn),a:l.a*(0.4+Math.random()*0.6),sp:l.s,ts:0.005+Math.random()*0.02,to:Math.random()*Math.PI*2,c:C[Math.random()*C.length|0]})}}
      let sY=0;addEventListener('scroll',()=>{sY=pageYOffset},{passive:true});
      let t=0;function d(){x.clearRect(0,0,W,H);t++;for(const s of stars){const y=(s.y-sY*s.sp)%(H*3);const sy=y<0?y+H*3:y;if(sy>H+5)continue;const tw=0.4+0.6*Math.abs(Math.sin(t*s.ts+s.to));x.globalAlpha=s.a*tw;x.fillStyle=s.c;x.beginPath();x.arc(s.x,sy,s.sz,0,Math.PI*2);x.fill();if(s.sz>1.8){x.globalAlpha=s.a*tw*0.15;x.beginPath();x.arc(s.x,sy,s.sz*4,0,Math.PI*2);x.fill()}}x.globalAlpha=1;requestAnimationFrame(d)}
      rs();cs();d();addEventListener('resize',()=>{rs();cs()});
    })();
    /* Scroll progress */
    (function(){const b=document.getElementById('scroll-progress');addEventListener('scroll',()=>{const h=document.documentElement.scrollHeight-innerHeight;b.style.width=h>0?(pageYOffset/h*100)+'%':'0%'},{passive:true})})();
    /* Scroll reveal */
    (function(){const o=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');o.unobserve(e.target)}})},{threshold:0.1});document.querySelectorAll('.reveal').forEach(e=>o.observe(e))})();
    /* Mouse trail */
    (function(){const c=['#22d3ee','#818cf8','#a855f7','#ec4899','#e8edf5'];let th=0;document.addEventListener('mousemove',e=>{th++;if(th%3)return;const p=document.createElement('div');p.className='cursor-particle';const s=3+Math.random()*5;p.style.cssText=`width:${s}px;height:${s}px;left:${e.clientX-s/2+(Math.random()-.5)*12}px;top:${e.clientY-s/2+(Math.random()-.5)*12}px;background:${c[Math.random()*c.length|0]};box-shadow:0 0 ${s*2}px ${p.style.background}`;document.body.appendChild(p);setTimeout(()=>p.remove(),800)})})();

    /* Claim logic */
    (function () {
      const claimToken = "{{ claim_token }}";
      if (!claimToken) {
        document.getElementById('loading').classList.add('hidden');
        const el = document.getElementById('load-err');
        el.classList.remove('hidden');
        el.querySelector('#load-err-text').textContent = 'Invalid claim link.';
        return;
      }
      let claimData = null;
      async function loadClaimData() {
        const r = await fetch("/api/claim/data/" + encodeURIComponent(claimToken));
        const data = await r.json().catch(() => ({}));
        document.getElementById('loading').classList.add('hidden');
        if (!r.ok) {
          document.getElementById('load-err').classList.remove('hidden');
          document.getElementById('load-err-text').textContent = data.error || 'Invalid or expired claim link.';
          return;
        }
        claimData = data;
        document.getElementById('claim-card').classList.remove('hidden');
        document.getElementById('question-text').textContent = data.question || '(No question)';
        const benInput = document.getElementById('beneficiary');
        if (data.beneficiary_stellar_address) benInput.value = data.beneficiary_stellar_address;
        if (!data.account) {
          document.getElementById('question-text').innerHTML += ' <span style="color:var(--warn);font-size:0.9rem;">(Depositor account not found on network.)</span>';
          document.getElementById('claim-btn').disabled = true;
          document.getElementById('claim-msg').textContent = 'Cannot claim: depositor account not found on network.';
          document.getElementById('claim-msg').className = 'msg err';
        }
        document.querySelectorAll('input[name="receive_mode"]').forEach(function (radio) {
          radio.addEventListener('change', function () {
            document.getElementById('bank-dest').classList.toggle('hidden', this.value !== 'bank');
          });
        });
      }
      function str2ab(s){const b=new ArrayBuffer(s.length);const v=new Uint8Array(b);for(let i=0;i<s.length;i++)v[i]=s.charCodeAt(i);return b}
      function b64decode(b64){return str2ab(atob(b64.replace(/-/g,'+').replace(/_/g,'/')))}
      async function deriveKey(pw,salt,iter,kl){const k=await crypto.subtle.importKey('raw',new TextEncoder().encode(pw),'PBKDF2',false,['deriveBits']);const d=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:iter,hash:'SHA-256'},k,kl*8);return crypto.subtle.importKey('raw',d,{name:'AES-GCM'},false,['decrypt'])}
      async function decryptSecret(ct,nonce,key){return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:nonce},key,ct))}
      async function unlockSecret(answer){const kdf=claimData.kdf;return await decryptSecret(b64decode(claimData.ciphertext_b64),b64decode(claimData.nonce_b64),await deriveKey(answer,b64decode(claimData.salt_b64),kdf.iterations||100000,kdf.keyLength||32))}
      function parseStellarDecimal(s){s=String(s).trim();const i=s.indexOf('.');return i===-1?{whole:s,frac:'0000000'}:{whole:s.slice(0,i)||'0',frac:(s.slice(i+1)+'0000000').slice(0,7)}}
      function toStroops(w,f){return BigInt(w)*10000000n+BigInt(f.padEnd(7,'0').slice(0,7))}
      function fromStroops(s){const st=s.toString().padStart(8,'0');return(st.slice(0,-7)||'0')+'.'+st.slice(-7)}
      async function buildSweepTransaction(secretKey,beneficiaryAddress){
        const S=window.StellarSdk,a=claimData.account;
        if(!a||!a.balances||!a.balances.length)throw new Error('Account not found or has no balances.');
        const kp=S.Keypair.fromSecret(secretKey),sa=new S.Account(kp.publicKey(),a.sequence);
        const fee=(typeof S.BASE_FEE!=='undefined')?S.BASE_FEE:100;
        const b=new S.TransactionBuilder(sa,{fee:String(fee),networkPassphrase:claimData.network_passphrase});
        let ops=0,xlmAmt='0';const reserve=(2+parseInt(a.subentry_count,10)||0)*5000000;
        for(const bal of a.balances){
          if(bal.asset_type==='native'){const{whole,frac}=parseStellarDecimal(bal.balance);const st=toStroops(whole,frac);if(st<=reserve)continue;xlmAmt=fromStroops(st-BigInt(reserve));b.addOperation(S.Operation.payment({destination:beneficiaryAddress,asset:S.Asset.native(),amount:xlmAmt}));ops++}
          else{if(parseFloat(bal.balance)<=0)continue;b.addOperation(S.Operation.payment({destination:beneficiaryAddress,asset:new S.Asset(bal.asset_code,bal.asset_issuer),amount:String(bal.balance)}));ops++}
        }
        if(!ops)throw new Error('No spendable balance.');
        const tx=b.setTimeout(180).build();tx.sign(kp);return{xdr:tx.toEnvelope().toXDR('base64'),nativeXlmAmount:xlmAmt}
      }
      document.getElementById('claim-btn').addEventListener('click', async function(){
        const msgEl=document.getElementById('claim-msg'),answer=document.getElementById('answer').value.trim();
        const mode=document.querySelector('input[name="receive_mode"]:checked').value,ben=document.getElementById('beneficiary').value.trim();
        if(!answer){msgEl.textContent='Enter the answer.';msgEl.className='msg err';return}
        if(!ben||ben.length!==56||!ben.startsWith('G')){msgEl.textContent='Enter a valid Stellar address (G…, 56 chars).';msgEl.className='msg err';return}
        if(mode==='bank'){const h=document.getElementById('bank_holder').value.trim(),ac=document.getElementById('bank_account').value.trim(),ifsc=document.getElementById('bank_ifsc').value.trim();if(!h||!ac||!ifsc){msgEl.textContent='Fill bank details.';msgEl.className='msg err';return}}
        msgEl.textContent='Unlocking…';msgEl.className='msg loading';this.disabled=true;
        try{
          const sk=await unlockSecret(answer);msgEl.textContent='Building sweep transaction…';
          const res=await buildSweepTransaction(sk,ben);msgEl.textContent='Submitting…';
          const r=await fetch('/api/claim/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({signed_envelope_xdr:res.xdr})});
          const d=await r.json().catch(()=>({}));
          if(r.ok&&d.status==='success'){
            if(mode==='bank'){msgEl.textContent='Sweep done. Requesting bank payout…';const or=await fetch('/api/claim/offramp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({claim_token:claimToken,bank_account_holder:document.getElementById('bank_holder').value.trim(),bank_account_number:document.getElementById('bank_account').value.trim(),bank_ifsc:document.getElementById('bank_ifsc').value.trim(),bank_name:document.getElementById('bank_name').value.trim(),amount_xlm:res.nativeXlmAmount})});const od=await or.json().catch(()=>({}));if(or.ok&&od.status==='success'){msgEl.textContent='Sweep successful. '+(od.message||'')+' Order: '+(od.order_id||'')+'. '+(od.amount_inr_mock!=null?'~₹'+od.amount_inr_mock+' (mock).':'');msgEl.className='msg ok'}else{msgEl.textContent='Sweep done. Bank payout error: '+(od.error||'unknown');msgEl.className='msg err'}}
            else{msgEl.textContent='Success! Transaction hash: '+(d.hash||'submitted');msgEl.className='msg ok'}
          }else{
            let errMsg = d.error || 'Submit failed';
            if (d.result_codes) {
              const rc = d.result_codes;
              const codes = [rc.transaction || '', ...(rc.operations || [])].filter(Boolean).join(', ');
              if (codes) errMsg += ' [' + codes + ']';
            }
            msgEl.textContent = errMsg;
            msgEl.className = 'msg err';
          }
        }catch(e){msgEl.textContent=e.message||'Error (wrong answer or no balance?)';msgEl.className='msg err'}
        this.disabled=false;
      });
      loadClaimData();
    })();
  </script>
</body>
</html>
